<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <title>שאלון להתאמת התנדבות</title>

  <!-- מניעת זום כפול / pinch -->
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />

  <!-- TailwindCSS CDN (darkMode=media) -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <!-- Google Font: Assistant -->
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    html { direction: rtl; scroll-behavior: smooth; touch-action: manipulation; }
    body { margin: 0; padding: 0; font-family: 'Assistant', sans-serif; background-color:#F5F7FA; color:#0C1A42; }

    /* מצב כהה – ניגודיות מובטחת */
    @media (prefers-color-scheme: dark) {
      body { background-color:#1E1E1E; color:#E8E8E8; }
      .bg-white        { background-color:#2A2A2A !important; }
      .bg-gray-50      { background-color:#1E1E1E !important; }
      .border-blue-700 { border-color:#4F82FF !important; }
      .bg-blue-50      { background-color:#1A365D !important; color:#E2E8F0 !important; }
      .text-blue-800   { color:#93C5FD !important; }
      .text-gray-800   { color:#D1D5DB !important; }
      .text-green-700  { color:#6EE7B7 !important; }
      .text-yellow-700 { color:#FDE68A !important; }
      .text-red-700    { color:#FCA5A5 !important; }
    }
    h1 { font-size: clamp(1.5rem, 5vw, 2rem); }
    h2 { font-size: clamp(1.2rem, 4vw, 1.5rem); }
    .chart-container { width:300px;height:300px;display:flex;align-items:center;justify-content:center;position:relative; }
    .answer-btn { transition:all .2s ease; }
    .answer-btn:hover { transform:translateY(-2px);box-shadow:0 4px 6px rgba(0,0,0,.1); }
    .hidden { display:none!important; }
    .visitor-counter { font-size:1rem;font-weight:600;margin-bottom:1rem;text-align:center; }
    .amuta-gallery { margin-top:.5rem; }
    .amuta-gallery.hidden { display:none; }
    .amuta-gallery img,.amuta-gallery video,.amuta-gallery iframe { max-width:100%;border-radius:.5rem;margin-bottom:.5rem; }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 md:p-6 bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 font-[Assistant]">
  <!-- 🟢 אין תגיות <body> כפולות מכאן והלאה -->

  <!-- קאונטר מבקרים -->
  <div class="visitor-counter">
    מספר המבקרים באתר עד כה: <span id="counter-value">670</span>
  </div>

  <!-- ====== Intro ====== -->
  <div id="intro-container" class="w-full max-w-2xl bg-white dark:bg-gray-800 shadow-lg rounded-xl p-8 mb-6 border-4 border-blue-700 dark:border-blue-400">
    <div class="text-center mb-6">
      <i class="fas fa-hands-helping text-blue-600 dark:text-blue-400 text-5xl mb-4"></i>
      <h1 class="text-3xl font-bold text-blue-800 dark:text-blue-200 mb-4">שאלון התאמה להתנדבות</h1>
      <p class="mb-6 leading-relaxed text-lg text-gray-800 dark:text-gray-200">
        לכל אדם יש משהו טוב לתת לעולם – <strong>כל אחד בדרך שלו.</strong><br />
        יש מי שמתחבר למוזיקה ומנגן כדי לשמח חולים,<br />
        ויש מי שאוהב אקשן ומתנדב בגופי החירום השונים.<br /><br />
        <strong>השאלון שלפניך</strong> נועד לעזור לך לגלות איפה בדיוק נמצא המקום<br />
        שבו תרגיש הכי משמעותי והכי מועיל.<br /><br />
        השאלון מעט ארוך, אך <strong>התוצאה בהחלט שווה את זה.</strong><br /><br />
        <em>הערה: השאלון לא מחייב אותך להתנדב בשום מקום, אלא רק נותן לך כיוון.</em><br />
        <em>1הערה נוספת: השאלון נכתב מטעמי נוחות בלבד בלשון זכר אך פונה לשני המינים.</em>
      </p>
      <button id="startQuizBtn" class="bg-blue-700 hover:bg-blue-600 dark:bg-blue-500 dark:hover:bg-blue-400 text-white px-8 py-3 rounded-lg transition-colors text-lg font-semibold"><i class="fas fa-play mr-2"></i> התחל שאלון</button>
    </div>
  </div>

<!-- ====== Quiz Card ====== -->
<div id="question-container" class="w-full max-w-md bg-white shadow-lg rounded-xl p-6 mb-6 border-4 border-blue-700 hidden">
  <!-- Progress -->
  <div class="mb-6">
    <div id="progress-indicator" class="text-sm font-medium text-blue-700 mb-1"></div>
    <div class="w-full bg-gray-200 rounded-full h-2.5">
      <div id="progress-bar" class="bg-blue-700 h-2.5 rounded-full transition-all duration-300" style="width:0%"></div>
    </div>
  </div>
  <!-- Question -->
  <div id="question-card" class="text-center mb-6">
    <h2 id="question-text" class="font-semibold mb-6 text-xl"></h2>
    <div class="flex flex-col gap-4">
      <button class="answer-btn border-4 border-green-500 rounded-xl bg-white text-green-700 font-semibold h-14 hover:bg-green-50 flex items-center justify-center gap-2" data-value="yes">
        <i class="fas fa-check-circle text-xl"></i> כן
      </button>
      <button class="answer-btn border-4 border-yellow-500 rounded-xl bg-white text-yellow-700 font-semibold h-14 hover:bg-yellow-50 flex items-center justify-center gap-2" data-value="maybe">
        <i class="fas fa-question-circle text-xl"></i> בערך
      </button>
      <button class="answer-btn border-4 border-red-500 rounded-xl bg-white text-red-700 font-semibold h-14 hover:bg-red-50 flex items-center justify-center gap-2" data-value="no">
        <i class="fas fa-times-circle text-xl"></i> לא
      </button>
    </div>
  </div>
  <!-- Nav -->
  <div class="flex justify-between">
    <button id="backBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-lg transition-colors flex items-center" style="visibility:hidden;">
      <i class="fas fa-arrow-left ml-2"></i> חזור
    </button>
    <button id="skipBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-lg transition-colors flex items-center">
      דלג <i class="fas fa-forward mr-2"></i>
    </button>
  </div>
</div>

<!-- ====== Results ====== -->
<div id="results-container" class="w-full max-w-2xl bg-white shadow-lg rounded-xl p-6 border-4 border-blue-700 hidden">
  <div class="text-center mb-6">
    <i class="fas fa-chart-pie text-blue-600 text-5xl mb-4"></i>
    <h2 class="text-2xl font-bold text-blue-800 mb-2">תוצאות השאלון שלך</h2>
    <p class="text-gray-600">לפניך פילוח ההתאמה שלך לסוגי ההתנדבויות השונות</p>
  </div>

  <!-- Pie -->
  <div class="mb-8">
    <h3 class="text-lg font-semibold mb-4 text-center">
      <i class="fas fa-chart-pie mr-2"></i> התפלגות ההתאמה
    </h3>
    <div class="flex items-center justify-center mx-auto w-[300px] h-[300px] chart-container">
      <canvas id="pieChart"></canvas>
    </div>
  </div>

  <div class="text-center mt-4 text-lg text-blue-800 font-semibold mb-4">
    איזה בן אדם מדהים את/ה! זה המקומות שיכולים להתאים לך:
  </div>

  <div id="recommended-amutas" class="space-y-4 mb-4"></div>

  <!-- כפתור הצגת כל העמותות -->
  <div class="text-center mt-2">
    <button id="showAllBtn"
            class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg transition-colors text-base font-semibold">
      לכל המקומות באתר
    </button>
  </div>

  <div class="text-center mt-4">
    <button id="whatsappBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition-colors text-base font-semibold inline-flex items-center gap-2">
      <i class="fab fa-whatsapp text-xl"></i> אני רוצה עוד פרטים!
    </button>
  </div>

  <div class="text-center mt-4">
    <button id="readMoreBtn" class="bg-blue-700 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors text-base font-semibold">
      מידע נוסף
    </button>
  </div>

  <div id="moreContent" class="hidden mt-4">
    <p class="text-center text-blue-800 font-semibold mb-2">הארגונים שמופיעים באתר שלנו</p>
    <div class="grid grid-cols-2 gap-2">
      <img src="https://hitnadvut.kfar-saba.muni.il/wp-content/uploads/2020/12/%D7%99%D7%93%D7%99%D7%93%D7%99%D7%9D-%D7%9E%D7%A1%D7%9E%D7%9B%D7%99-%D7%99%D7%A1%D7%95%D7%93-%D7%9C%D7%95%D7%92%D7%95-%D7%A1%D7%99%D7%95%D7%A2-%D7%91%D7%93%D7%A8%D7%9B%D7%99%D7%9D-%D7%A9%D7%97%D7%95%D7%A8-2019-002.jpg" alt="ידידים" />
      <img src="https://yt3.googleusercontent.com/ytc/AIdro_maqfIGvladPDhPnOhnjKPO9GDra6La1SLnvAr3IDF8iw=s900-c-k-c0x00ffffff-no-rj" alt="שמח בבתי חולים" />
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/68/FireDepIsrael.svg/250px-FireDepIsrael.svg.png" alt="כבאות והצלה" />
      <img src="https://www.mishan-lamarpe.org.il/wp-content/uploads/2015/01/%D7%9E%D7%A9%D7%A2%D7%9F-%D7%9C%D7%9E%D7%A8%D7%A4%D7%90.jpg" alt="משען למרפא" />
    </div>
  </div>

  <div class="text-center mt-8">
    <button onclick="location.reload()" class="bg-blue-700 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors font-semibold">
      <i class="fas fa-redo mr-2"></i> התחלה מחדש
    </button>
  </div>
</div>

<script>
/* ========================================
   מניעת זום בדאבל‑קליק בדפדפנים מסויימים
   ======================================== */
document.addEventListener("dblclick", e => e.preventDefault());

/* ========================================
   1) קאונטר מבקרים (CounterAPI)
   ======================================== */
   <!-- Visitor Counter – improved -->
(function () {
  const BASE = "https://api.counterapi.dev/v1";
  const NS   = "matchgood1";
  const NAME = "visits";
  const REFRESH_MS = 60_000;          // רענון כל 60 שניות
  const LS_KEY = "matchgood1-counter";

  /** עדכון מונה – @param {boolean} inc העלאה? */
  async function updateCounter(inc = false) {
    const endpoint = inc
      ? `${BASE}/${NS}/${NAME}/up`
      : `${BASE}/${NS}/${NAME}?t=${Date.now()}`; // cache‑buster

    try {
      const res  = await fetch(endpoint, { headers: { Accept: "application/json" }, cache: "no-cache" });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || res.status);

      renderCount(data.count);
      localStorage.setItem(LS_KEY, data.count);   // שמירה לערך עתידי
    } catch (err) {
      console.error("CounterAPI:", err);
      renderCount("—");                           // מקף מפריד במקום 0
    }
  }

  /** הדפסת הערך עם אנימציה */
  function renderCount(val) {
    const el = document.getElementById("counter-value");
    if (!el) return;
    el.textContent = val;
    el.style.animation = "pop .5s ease";
  }

  /* === עיצוב אנימציה === */
  const style = document.createElement("style");
  style.textContent = `@keyframes pop{0%{transform:scale(1)}50%{transform:scale(1.25)}100%{transform:scale(1)}}`;
  document.head.appendChild(style);

  /* === הפעלה === */
  document.addEventListener("DOMContentLoaded", () => {
    // תצוגת ערך אחרון מה‑localStorage בזמן שה‑fetch רץ
    const cached = localStorage.getItem(LS_KEY);
    if (cached) renderCount(cached);

    // קריאה ראשונה – מעלה את המונה
    updateCounter(true);

    // רענונים שוטפים (ללא העלאה)
    setInterval(() => updateCounter(false), REFRESH_MS);
  });
})();

/* ========================================
   2) פונקציות מדיה (YouTube / Drive / תמונות)
   ======================================== */
function createMediaElement(url) {
  if (url.includes("youtu")) {
    const iframe = document.createElement("iframe");
    iframe.className = "w-full h-56";
    iframe.src = convertYoutubeLink(url);
    iframe.frameBorder = "0";
    iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
    iframe.allowFullscreen = true;
    return iframe;
  }

  if (url.includes("drive.google.com")) {
    const iframe = document.createElement("iframe");
    iframe.className = "w-full h-56";
    iframe.src = convertDriveLink(url);
    iframe.frameBorder = "0";
    iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
    iframe.allowFullscreen = true;
    return iframe;
  }

  if (url.match(/\.(mp4|webm)(\?.*)?$/i)) {
    const video = document.createElement("video");
    video.className = "w-full h-56";
    video.src = url;
    video.controls = true;
    return video;
  }

  const img = document.createElement("img");
  img.src = url;
  return img;
}
function convertYoutubeLink(url) {
  if (url.includes("youtu.be/")) return "https://www.youtube.com/embed/" + url.split("youtu.be/")[1];
  if (url.includes("watch?v=")) return "https://www.youtube.com/embed/" + url.split("watch?v=")[1].split("&")[0];
  return url;
}
function convertDriveLink(url) {
  let fileId = "";
  if (url.includes("/d/")) fileId = url.split("/d/")[1].split("/")[0];
  else if (url.includes("id=")) fileId = url.split("id=")[1].split("&")[0];
  return fileId ? `https://drive.google.com/file/d/${fileId}/preview` : url;
}

/* ========================================
   3) שאלות
   ======================================== */
const questions = [
  { id:"q1",  text:"האם אתה אוהב לעבוד עם הרבה אנשים ביחד?",      amutas:["mda","special","joy"] },
  { id:"q2",  text:"אתה בדרך כלל זמין בווצאפ?",                    amutas:["mda","fire","yedidim"] },
  { id:"q3",  text:"יש לך ניסיון עם צרכים מיוחדים (מכל סוג)?",     amutas:["hand","joy","special"] },
  { id:"q4",  text:"אתה מסוגל לעבוד תחת לחץ?",                     amutas:["mda","fire","yedidim"] },
  { id:"q5",  text:"אתה טיפוס שאוהב להוציא אנרגיות?",              amutas:["hand","joy","special"] },
  { id:"q6",  text:"האם אתה מתנדב כבר במקום כלשהו?",               amutas:["mda","fire","yedidim"] },
  { id:"q7",  text:"אתה מוזיקאי או סתם אוהב לשיר ולנגן?",           amutas:["joy","hand","special"] },
  { id:"q8",  text:"אתה מבלה הרבה זמן בנסיעות?",                   amutas:["yedidim"] },
  { id:"q9",  text:"יש לך רישיון נהיגה?",                          amutas:["mda","yedidim"] },
  { id:"q10", text:"האם אתה פנוי בשבתות?",                         amutas:["mda","yedidim"] },
  { id:"q11", text:"האם תוכל להקדיש יום ספציפי בשבוע להתנדבות?",   amutas:["joy","hand","special"] },
  { id:"q12", text:"אתה אוהב אתגרים?",                              amutas:["mda","yedidim","special"] },
  { id:"q13", text:"האם אתה מסוגל להיות שמח גם במצבים עצובים?",    amutas:["mda","yedidim"] },
  { id:"q14", text:"מסוגל לעבוד מכל הלב בלי לצפות לתמורה?",        amutas:["special","yedidim","joy","hand"] },
  { id:"q15", text:"האם אתה מרגיש שאתה יכול להשפיע על אדם אחר?",   amutas:["joy","hand","special"] },
  { id:"q16", text:"האם תהיה מוכן לעבור הכשרה פיזית ומעשית?",      amutas:["mda","yedidim","fire"] },
  { id:"q17", text:"אתה אדם יצירתי?",                               amutas:["mda","special","joy"] },
  { id:"q18", text:"אתה מגדיר את עצמך בעל ביטחון עצמי גבוה?",      amutas:["mda","fire","special"] },
  { id:"q19", text:"האם יש לך אחים קטנים?",                        amutas:["hand","special"] },
  { id:"q20", text:"האם אתה מסוגל להתחייב לזמן ממושך?",            amutas:["mda","fire","hand"] },
  { id:"q21", text:"אתה ספונטני?",                                  amutas:["joy"] },
  { id:"q22", text:"האם אתה יודע לתפקד טוב שאין ודאות מוחלטת?",    amutas:["mda","fire","special"] },
  { id:"q23", text:"האם אתה רואה ערך בעשייה לטווח ארוך?",          amutas:["hand","special"] },
  { id:"q24", text:"חשוב לך לדעת שהעשייה שלך משנה?",               amutas:["yedidim","mda","hand"] },
  { id:"q25", text:"האם אתה רואה את עצמך כמודל לחיקוי?",           amutas:["mda","yedidim"] },
  { id:"q26", text:"האם תוכל להתנדב במקום שבו לא דווקא יכירו לך תודה?",  amutas:["mda","fire","special"] }
];

/* ========================================
   4) נתוני עמותות
   ======================================== */
const AMUTA_DATA = {
  mda: {
    name: "מד\"א – מגן דוד אדום",
    icon: "fa-ambulance",
    description: "זה לא משנה אם אתה נוער או בוגר יותר – בסופו של דבר, שניכם מצילים חיים. ללכת לישון בהרגשה שהיום הצלת חיים זו הרגשה מדהימה. ההתנדבות במד\"א נותנת לך פרופורציות וערך אמיתי לחיים, והיא מומלצת לכל אחד שמסוגל להתמודד עם מצבים מורכבים.",
    images: [
      "https://scontent.ftlv5-1.fna.fbcdn.net/v/t39.30808-6/468321608_10161557319136708_4653121418500952521_n.png?_nc_cat=100&ccb=1-7&_nc_sid=0b6b33&_nc_ohc=XqD2e2vzEiAQ&_nc_ht=scontent.ftlv5-1.fna&oh=00_AfG4ajakisi0fGejnJDVmR8C8qaB3-gVT0b4l4g6pDs0cQ&oe=67FE1F8F",
      "https://swords.ifmda.org.il/wp-content/uploads/2023/10/%D7%A6%D7%95%D7%95%D7%AA%D7%99-%D7%9E%D7%93%D7%90-%D7%91%D7%96%D7%99%D7%A8%D7%AA-%D7%A0%D7%A4%D7%99%D7%9C%D7%94-%D7%91%D7%90%D7%A9%D7%A7%D7%9C%D7%95%D7%9F-1024x768.jpg"
    ]
  },
  fire: {
    name: "כבאות והצלה",
    icon: "fa-fire",
    description: "כבאות והצלה זה לא רק כיבוי אש – זה גם חילוצים והצלת חיים במצבים מורכבים ומאתגרים מאוד. ההתנדבות בכבאות והצלה היא מאתגרת ומספקת במיוחד, ומומלצת מאוד לחובבי האדרנלין שבינינו.",
    images: [
      "https://www.gov.il/BlobFolder/guide/induction_process/he/FIRE220112KR850_1655.jpg",
      "https://www.gov.il/BlobFolder/news/recruitment_of_fire_fighters_2024/he/FIRE230115KR850_8859.jpg",
      "https://www.gov.il/BlobFolder/news/recruitment_of_fire_fighters_2024/he/FIRE230421KR850_1453.jpg",
      "https://youtu.be/uBbq91mKqUg"
    ]
  },
  yedidim: {
    name: "ידידים – עזרה בדרכים",
    icon: "fa-car",
    description: "אף אחד לא רוצה להיתקע באמצע כביש מהיר, אבל זה קורה – וקורה הרבה. דמיינו רגע את ההרגשה שהגעתם לעזור למשפחה שנתקעה בלי שמן או חילצתם ילד שננעל בתוך רכב. ההתנדבות בידידים לא דורשת ידע מורכב או ציוד מקצועי, ומתאימה גם למי שאין לו עדיין רישיון נהיגה. אתם מוזמנים להצטרף ולהושיט יד.",
    images: [
      "https://www.israelhayom.co.il/wp-content/uploads/2022/01/16075818009517_b.jpg",
      "https://beitarillit-online.com/wp-content/uploads/elementor/thumbs/WhatsApp-Image-2020-02-12-at-12.27.44-ol1zzwe06u55vy0kivfdtmx1ea55pgy2sapnzpoaww.jpeg?v=1581504974"
    ]
  },
  joy: {
    name: "לשמח חולים",
    icon: "fa-smile",
    description: "דמיינו שאתם חס ושלום בבית חולים, מביטים על הקירות ושוקעים בצער ובכאב. ופתאום מישהו נכנס ומנגן לכם שיר שאתם אוהבים. ההתנדבות הזו היא הזדמנות להקל על חולים, לתת להם תקווה, חיוך והפוגה מהכאב. ההרגשה שתצאו איתה היא סיפוק ענק שאין לו תחליף.",
    images: [
      "https://drive.google.com/file/d/1NTZPoWO-XhsYPkCppJLA4teW-xDOFsE5/preview",
      "https://drive.google.com/file/d/1GWp3xqUVcnTgo8mOSdF5OlZQQtwBx--B/preview"
    ]
  },
  hand: {
    name: "להושיט יד",
    icon: "fa-hand-holding-heart",
    description: "לרובנו יש אחים גדולים וקטנים, אך יש ילדים שאין להם דמות כזו בחיים. להושיט יד מחבר אתכם למשפחה שזקוקה לכם כאחים גדולים: לצאת עם הילד לטיולים, לעזור בשיעורי בית או סתם לשוחח על החיים. זו התנדבות לא פשוטה, אך לראות את הילד מתפתח ומקבל כלים לחיים – זו הרגשה מספקת וייחודית.",
    images: [
      "https://scontent.ftlv5-1.fna.fbcdn.net/v/t39.30808-6/488669456_1109292477901246_1785003350776734070_n.jpg?_nc_cat=107&ccb=1-7&_nc_sid=f727a1&_nc_ohc=q-d5K3o1TP4&_nc_ht=scontent.ftlv5-1.fna&oh=00_AfGroO59OaDALFvwju_ZO7-9sIEUp5LtSu8j-nIg-v4_wA&oe=681D2632",
      "https://l-yad.org/wp-content/uploads/2025/01/074A1584-2-2048x1365.jpg"
    ]
  },
  special: {
    name: "צרכים מיוחדים",
    icon: "fa-wheelchair",
    description: "לראות אדם שמתמודד עם מוגבלות פיזית קשה ובכל זאת מצליח לעשות משהו מדהים עם חייו – זו חוויה שמלמדת המון. ההתנדבות עם אנשים עם צרכים מיוחדים תפתח בכם סבלנות, אכפתיות ונתינה עצומה. אי אפשר לתאר במילים את הסיפוק שתרגישו כשתראו אותם מחייכים ומצליחים בזכותכם.",
    images: [
      "https://www.metar.muni.il/PublishingImages/%D7%91%D7%A0%D7%99%20%D7%A2%D7%A7%D7%99%D7%91%D7%90.jfif",
      "https://drive.google.com/file/d/1GrzsQ5FlYUlI7exCSPzp8tFz2341oWc5/preview"
    ]
  }
};

/* ========================================
   5) משתני ניהול
   ======================================== */
let currentQuestionIndex = 0;
const userAnswers = {};
questions.forEach(q => userAnswers[q.id] = {answer:null, answered:false});
const totalQuestions = questions.length;
let allAmutaResults = [];

/* === DOM refs === */
const introContainer      = document.getElementById("intro-container");
const questionContainer   = document.getElementById("question-container");
const resultsContainer    = document.getElementById("results-container");
const startQuizBtn        = document.getElementById("startQuizBtn");
const questionText        = document.getElementById("question-text");
const progressBar         = document.getElementById("progress-bar");
const progressIndicator   = document.getElementById("progress-indicator");
const backBtn             = document.getElementById("backBtn");
const skipBtn             = document.getElementById("skipBtn");
const answerBtns          = document.querySelectorAll(".answer-btn");
const recommendedAmutasDiv= document.getElementById("recommended-amutas");
const whatsappBtn         = document.getElementById("whatsappBtn");
const readMoreBtn         = document.getElementById("readMoreBtn");
const moreContent         = document.getElementById("moreContent");
const showAllBtn          = document.getElementById("showAllBtn");

/* ========================================
   6) גלריה כללית – קרא עוד
   ======================================== */
readMoreBtn.addEventListener("click", () => {
  moreContent.classList.toggle("hidden");
  readMoreBtn.textContent = moreContent.classList.contains("hidden") ? "מידע נוסף" : "הסתר";
});

/* ========================================
   7) זרימת שאלון
   ======================================== */
function showQuiz() {
  introContainer.classList.add("hidden");
  questionContainer.classList.remove("hidden");
  renderQuestion();
}
function renderQuestion() {
  if (currentQuestionIndex >= totalQuestions) { showResults(); return; }
  const q = questions[currentQuestionIndex];
  questionText.textContent = q.text;
  progressIndicator.textContent = `שאלה ${currentQuestionIndex + 1} מתוך ${totalQuestions}`;
  backBtn.style.visibility = currentQuestionIndex ? "visible" : "hidden";
  updateProgressBar();
}
function updateProgressBar() {
  progressBar.style.width = ((currentQuestionIndex+1)/totalQuestions)*100 + "%";
}
function nextQuestion(val=null) {
  if (val) {
    const id = questions[currentQuestionIndex].id;
    userAnswers[id] = {answer:val, answered:true};
  }
  currentQuestionIndex++;
  currentQuestionIndex < totalQuestions ? renderQuestion() : showResults();
}
function previousQuestion() {
  if (currentQuestionIndex) { currentQuestionIndex--; renderQuestion(); }
}

/* ========================================
   8) תוצאות
   ======================================== */
function showResults() {
  questionContainer.classList.add("hidden");
  resultsContainer.classList.remove("hidden");

  /* חישוב ניקוד */
  const amutaScores = Object.fromEntries(
    Object.keys(AMUTA_DATA).map(k => [k, {score:0, max:0}])
  );

  questions.forEach(q => {
    const ans = userAnswers[q.id];
    if (!ans.answered) return;
    const pts = ans.answer==="yes" ? 1 : ans.answer==="maybe" ? 0.5 : 0;
    q.amutas.forEach(k => {
      amutaScores[k].score += pts;
      amutaScores[k].max   += 1;
    });
  });

  allAmutaResults = Object.keys(amutaScores)
    .map(k => {
      const {score, max} = amutaScores[k];
      return { amKey:k,
               name:AMUTA_DATA[k].name,
               icon:AMUTA_DATA[k].icon,
               ratio:max ? (score/max)*100 : 0 };
    })
    .sort((a,b) => b.ratio - a.ratio);

  createPieChart(allAmutaResults);
  displayRecommendedAmutas(allAmutaResults.slice(0,3));
}

function createPieChart(arr) {
  const ctx = document.getElementById("pieChart").getContext("2d");
  new Chart(ctx, {
    type:"pie",
    data:{
      labels:arr.map(a=>a.name),
      datasets:[{
        data:arr.map(a=>a.ratio),
        backgroundColor:["#2E93FA","#66DA26","#E91E63","#FF9800","#8B5CF6","#EC4899"],
        borderWidth:1
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{position:'bottom', rtl:true},
        tooltip:{callbacks:{label:ctx=>`${ctx.label}: ${ctx.raw.toFixed(1)}% התאמה`}}
      }
    }
  });
}

function displayRecommendedAmutas(arr) {
  recommendedAmutasDiv.innerHTML = "";
  arr.forEach(a=>{
    const ratioStr = a.ratio.toFixed(1);
    const gid = "gallery-"+a.amKey;
    const card = document.createElement("div");
    card.className = "bg-blue-50 rounded-lg p-4 border border-blue-200";
    card.innerHTML = `
      <div class="flex items-start gap-4">
        <div class="flex-shrink-0 w-12 h-12 rounded-full bg-blue-700 flex items-center justify-center text-white text-2xl">
          <i class="fas ${a.icon}"></i>
        </div>
        <div class="flex-1 space-y-2">
          <h4 class="font-bold text-lg text-blue-800">${a.name}</h4>
          <span class="inline-block text-xs font-bold px-2 py-1 rounded-full bg-blue-100 text-blue-700">
            ${ratioStr}% התאמה
          </span>
          <p class="text-sm text-gray-800 leading-relaxed">
            ${(() => {
              const firstSentence = AMUTA_DATA[a.amKey].description.split(".")[0] + ".";
              const rest = AMUTA_DATA[a.amKey].description.replace(firstSentence, "").trim();
              return `<span class="font-semibold text-blue-900">${firstSentence}</span> ${rest}`;
            })()}
          </p>
          <button class="bg-blue-700 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm font-semibold"
                  onclick="toggleAmutaGallery('${gid}')">
            לתמונות וסרטונים
          </button>
          <div id="${gid}" class="amuta-gallery hidden"></div>
        </div>
      </div>`;
    recommendedAmutasDiv.appendChild(card);

    const galDiv = card.querySelector(`#${gid}`);
    AMUTA_DATA[a.amKey].images.forEach(u=>galDiv.appendChild(createMediaElement(u)));
  });
}
window.toggleAmutaGallery = id => document.getElementById(id)?.classList.toggle("hidden");

/* ========================================
   9) כפתור WhatsApp
   ======================================== */
whatsappBtn.addEventListener("click", () => {
  const phone   = "972508787826";
  const message = "היי, מילאתי את השאלון שלך ואשמח לשמוע עוד פרטים לגבי ההתנדבות";
  window.open(`https://api.whatsapp.com/send?phone=${phone}&text=${encodeURIComponent(message)}`, "_blank");
});

/* ========================================
   10) כפתור “לכל המקומות באתר”
   ======================================== */
showAllBtn.addEventListener("click", () => {
  displayRecommendedAmutas(allAmutaResults);
  showAllBtn.classList.add("hidden");            // מסתיר את הכפתור לאחר הלחיצה
});

/* ========================================
   11) מאזיני כפתורים
   ======================================== */
startQuizBtn.addEventListener("click",showQuiz);
answerBtns.forEach(b=>b.addEventListener("click",()=>nextQuestion(b.dataset.value)));
skipBtn.addEventListener("click", ()=>nextQuestion());
backBtn.addEventListener("click", previousQuestion);
</script>
</body>
</html>
